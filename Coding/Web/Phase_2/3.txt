	WITH posts_per_year AS (
		SELECT 
                	t.id AS tech_id,
                	t.technology_name,
                	YEAR(u.date_time) AS year,
                	COUNT(*) AS posts_in_year
            FROM technologies t
            LEFT JOIN post p ON t.id = p.tech_id
            LEFT JOIN user_upload_post u ON u.post_id = p.id
            GROUP BY t.id, year
        ),
        ranked_years AS (
            SELECT *,
                   RANK() OVER (PARTITION BY tech_id ORDER BY posts_in_year DESC) AS rnk
            FROM posts_per_year
        )
        SELECT 
            t.technology_name,
            COUNT(p.tech_id) AS post_count,
            COUNT(DISTINCT p.user_id) AS user_count,
            ry.year AS top_year
        FROM technologies t
        LEFT JOIN post p ON t.id = p.tech_id
        LEFT JOIN ranked_years ry ON t.id = ry.tech_id AND ry.rnk = 1
        GROUP BY t.id
        ORDER BY post_count DESC;